# Grape 开发优化清单（合并最终版）

> 基于代码审查和开发迭代，整合原始清单、P0-P3 问题清单，形成统一的优化清单。
>
> **优先级说明**
> - 🔴 **P0 紧急**：影响基本可用性或存在严重安全漏洞
> - 🟠 **P1 重要**：影响可扩展性和安全性
> - 🟡 **P2 中期**：提升功能完整度和工程质量
> - 🟢 **P3 长期**：企业级能力和生态完善
>
> **最后更新**：2026-02-26

---

## 功能统计

| 类别 | 已完成 | 待优化 | 暂缓实现 | 合计 |
|------|--------|--------|----------|------|
| 原始25项 | 21 | 0 | 4 | 25 |
| P0 问题 | 4 | 0 | 0 | 4 |
| P1 问题 | 6 | 1 | 0 | 7 |
| P2 问题 | 10 | 0 | 0 | 10 |
| P3 问题 | 5 | 1 | 0 | 6 |
| **总计** | **46** | **2** | **4** | **52** |

---

## 一、原始25项功能清单

> 来自项目规划阶段的初始功能列表

### ✅ 已完成（21项）

| 编号 | 任务 | 涉及文件 | 说明 |
|------|------|----------|------|
| 1 | 前端 axios 注入 JWT | `web/src/api/index.ts` | request interceptor 自动注入 Bearer token |
| 2 | 管理后台联调后端真实接口 | `web/src/api/index.ts` | adminApi 完整对接 |
| 3 | 用户数据持久化（SQLite + GORM） | `internal/db/db.go`, `internal/db/models.go` | GORM + SQLite |
| 4 | scoped 包列表逻辑修复 | `internal/storage/local/storage.go` | ListPackages 递归扫描 |
| 5 | 前端 baseURL 同源修复 | `web/src/api/index.ts` | baseURL 为空字符串，同源策略 |
| 6 | 安全配置强化 | `internal/config/config.go`, `internal/server/handler/auth.go` | AllowRegistration + 限流 |
| 7 | 包发布并发安全 | `internal/server/handler/publish.go` | sync.Map + defer Delete |
| 8 | 存储层接口抽象 | `internal/storage/storage.go` | storage.Storage 接口定义 |
| 9 | 错误响应格式标准化 | `internal/server/handler/` | 统一错误码结构 |
| 10 | 补全自动化测试 | `internal/auth/user_test.go`, `internal/storage/local/storage_test.go` | 单元测试覆盖 |
| 12 | 审计日志 | `internal/db/models.go`, `web/src/api/index.ts` | audit-logs API + 前端展示 |
| 13 | dist-tag 管理 API | `internal/server/handler/registry.go` | dist-tags 增删改查 |
| 14 | 包版本管理增强 | `internal/server/handler/publish.go` | delete + deprecate |
| 15 | 包详情页完善 | `web/src/views/PackageDetail.vue` | README 渲染 + 版本历史 |
| 17 | 配置热重载 | `internal/config/loader.go` | Viper WatchConfig |
| 19 | Docker 镜像与一键部署 | `Dockerfile`, `docker-compose.yml` | 多阶段构建 + 一键部署 |
| 20 | CI/CD 流水线 | `.github/workflows/` | ci.yml + docker.yml + release.yml |
| 22 | Webhook 事件通知 | `internal/webhook/webhook.go`, `internal/server/handler/webhook.go` | HMAC 签名 + 3次重试 |
| 24 | Prometheus 监控指标 | `internal/metrics/metrics.go`, `internal/server/server.go` | 8个核心指标 + /-/metrics 端点 |

### ❌ 暂缓实现（4项）

| 编号 | 任务 | 暂缓原因 |
|------|------|----------|
| 11 | RBAC 权限模型（casbin） | 成本高，当前角色系统已满足需求 |
| 16 | Redis 缓存集成 | 当前规模无需缓存层 |
| 18 | S3 / MinIO 对象存储 | 本地存储已满足需求 |
| 21 | LDAP / OIDC 企业认证 | 企业级需求，暂不实施 |
| 23 | 包安全扫描 | 需集成 OSV API，暂不实施 |
| 25 | 高可用集群模式 | 架构复杂度高 |

---

## 二、安全问题修复清单（P0-P2）

> 来自代码审查发现的安全问题和功能性 Bug

### 🔴 P0 紧急（4项）

| 编号 | 任务 | 涉及文件 | 状态 |
|------|------|----------|------|
| 26 | 路径穿越攻击漏洞修复 | `internal/storage/local/storage.go` | ✅ 完成 |
| 27 | 开放注册漏洞 | `internal/config/config.go`, `internal/server/handler/auth.go` | ✅ 完成 |
| 28 | 发布新版本覆盖元数据 | `internal/server/handler/publish.go` | ✅ 完成 |
| 29 | io.ReadAll 无限制 DoS | `internal/registry/proxy.go`, `internal/server/server.go` | ✅ 完成 |

**26. 路径穿越攻击漏洞** - 涉及文件：
- `internal/storage/local/storage.go` - validatePath() + validatePackageName() + validateFilename()
- `internal/server/server.go` - 路由层预校验

**27. 开放注册漏洞** - 涉及文件：
- `internal/config/config.go` - AllowRegistration 配置项
- `internal/server/handler/auth.go` - 注册开关逻辑

**28. 发布覆盖元数据** - 涉及文件：
- `internal/server/handler/publish.go` - mergeMetadata() 函数

**29. io.ReadAll 无限制** - 涉及文件：
- `internal/registry/proxy.go` - io.LimitReader 限制
- `internal/server/server.go` - maxBytesMiddleware(50MB)

---

### 🟠 P1 重要（7项）

| 编号 | 任务 | 涉及文件 | 状态 |
|------|------|----------|------|
| 30 | GORM ErrRecordNotFound 比较 | `internal/auth/db_user.go` | ✅ 完成 |
| 31 | 全局 DB 变量改依赖注入 | `internal/db/db.go` | ❌ 暂缓 |
| 32 | 移除 JWT query 参数 | `internal/auth/middleware.go` | ✅ 完成 |
| 33 | 密码复杂度验证 | `internal/auth/user.go` | ✅ 完成 |
| 34 | 角色白名单校验 | `internal/auth/user.go` | ✅ 完成 |
| 35 | 限流 goroutine 泄漏 | `internal/server/server.go`, `internal/server/handler/auth.go` | ✅ 完成 |
| 36 | unpublish 接口授权 | `internal/server/handler/publish.go` | ✅ 完成 |

**30. GORM ErrRecordNotFound** - 涉及文件：
- `internal/auth/db_user.go` - 使用 gorm.ErrRecordNotFound

**31. 全局 DB 变量** - 涉及文件：
- `internal/db/db.go` - var DB 全局变量（暂缓重构）

**32. JWT query 参数** - 涉及文件：
- `internal/auth/middleware.go` - 移除 c.Query("authToken")

**33. 密码复杂度** - 涉及文件：
- `internal/auth/user.go` - ValidatePassword() >= 8字符

**34. 角色白名单** - 涉及文件：
- `internal/auth/user.go` - ValidateRole() 白名单校验

**35. 限流器泄漏** - 涉及文件：
- `internal/server/handler/auth.go` - Stop() + StopLoginLimiter()
- `internal/server/server.go` - Shutdown() 调用

**36. unpublish 授权** - 涉及文件：
- `internal/server/handler/publish.go` - admin 角色检查

---

### 🟡 P2 中期（10项）

| 编号 | 任务 | 涉及文件 | 状态 |
|------|------|----------|------|
| 37 | 上游代理 URL 编码 | `internal/registry/proxy.go` | ✅ 完成 |
| 38 | json.Marshal 错误处理 | `internal/server/handler/publish.go` | ✅ 完成 |
| 39 | MemoryUserStore 返回值拷贝 | `internal/auth/user.go` | ✅ 完成 |
| 40 | 全局请求体大小限制 | `internal/server/server.go` | ✅ 完成 |
| 41 | web.Exists 文件句柄泄漏 | `internal/web/embed.go` | ✅ 完成 |
| 42 | 前端路由守卫验证 token | `web/src/router/index.ts` | ✅ 完成 |
| 43 | 前端管理路由角色检查 | `web/src/router/index.ts` | ✅ 完成 |
| 44 | 移除 console.error | `web/src/views/Packages.vue`, `web/src/views/PackageDetail.vue` | ✅ 完成 |
| 45 | 登录重定向安全校验 | `web/src/views/Login.vue` | ✅ 完成 |
| 46 | 发布锁 sync.Map 清理 | `internal/server/handler/publish.go` | ✅ 完成 |

**37. 上游代理 URL 编码** - 涉及文件：
- `internal/registry/proxy.go` - url.PathEscape()

**38. json.Marshal 错误处理** - 涉及文件：
- `internal/server/handler/publish.go` - 错误检查 + 日志记录

**39. MemoryUserStore 竞态** - 涉及文件：
- `internal/auth/user.go` - Get() / List() / Validate() 返回副本

**40. 请求体大小限制** - 涉及文件：
- `internal/server/server.go` - maxBytesMiddleware(50MB)

**41. 文件句柄泄漏** - 涉及文件：
- `internal/web/embed.go` - 使用 fs.Stat

**42. 路由守卫 token 验证** - 涉及文件：
- `web/src/router/index.ts` - isTokenValid() JWT 过期检查

**43. 管理路由角色检查** - 涉及文件：
- `web/src/router/index.ts` - requiresAdmin 守卫
- `web/src/stores/user.ts` - role 状态管理

**44. console.error 残留** - 涉及文件：
- `web/src/views/Packages.vue` - 已清除
- `web/src/views/PackageDetail.vue` - 已清除

**45. 登录重定向校验** - 涉及文件：
- `web/src/views/Login.vue` - getSafeRedirect()

**46. 发布锁清理** - 涉及文件：
- `internal/server/handler/publish.go` - defer Delete()

---

## 三、长期优化清单（P3）

| 编号 | 任务 | 涉及文件 | 状态 |
|------|------|----------|------|
| 47 | Users.vue 编辑功能 | `web/src/views/admin/Users.vue`, `internal/server/handler/auth.go` | ✅ 完成 |
| 48 | tarball URL 动态 baseURL | `internal/server/handler/registry.go` | ✅ 完成 |
| 49 | HTTP 安全响应头 | `internal/server/server.go` | ✅ 完成 |
| 50 | PackageVersion 联合唯一约束 | `internal/db/models.go` | ✅ 完成 |
| 51 | 日志过滤敏感参数 | `internal/server/server.go` | ❌ 待优化 |

**47. 用户编辑功能** - 涉及文件：
- `web/src/views/admin/Users.vue` - handleSaveEdit() 对接真实 API
- `web/src/api/index.ts` - updateUser()
- `internal/server/handler/auth.go` - UpdateUser() 接口
- `internal/auth/db_user.go` - Update() 方法

**48. tarball URL 动态 baseURL** - 涉及文件：
- `internal/server/handler/registry.go` - X-Forwarded-Host/Proto 动态获取
- `internal/config/config.go` - BaseURL 配置支持

**49. HTTP 安全响应头** - 涉及文件：
- `internal/server/server.go` - securityHeadersMiddleware()

**50. 联合唯一约束** - 涉及文件：
- `internal/db/models.go` - uniqueIndex:idx_pkg_version

**51. 日志过滤** - 涉及文件：
- `internal/server/server.go` - 自定义日志格式（待实现）

---

## 四、文件映射索引

### 后端核心文件

| 功能 | 文件路径 |
|------|----------|
| 主入口 | `cmd/grape/main.go` |
| 服务器 | `internal/server/server.go` |
| 配置加载 | `internal/config/config.go`, `internal/config/loader.go` |
| 日志 | `internal/logger/logger.go` |
| 数据库 | `internal/db/db.go`, `internal/db/models.go` |
| 认证 | `internal/auth/middleware.go`, `internal/auth/jwt.go`, `internal/auth/user.go`, `internal/auth/db_user.go` |
| 包发布 | `internal/server/handler/publish.go` |
| 包查询 | `internal/server/handler/registry.go` |
| 用户管理 | `internal/server/handler/auth.go` |
| Webhook | `internal/webhook/webhook.go`, `internal/server/handler/webhook.go` |
| 监控 | `internal/metrics/metrics.go` |
| 存储 | `internal/storage/storage.go`, `internal/storage/local/storage.go` |
| 代理 | `internal/registry/proxy.go` |
| 嵌入前端 | `internal/web/embed.go` |

### 前端核心文件

| 功能 | 文件路径 |
|------|----------|
| API 封装 | `web/src/api/index.ts` |
| 路由 | `web/src/router/index.ts` |
| 用户状态 | `web/src/stores/user.ts` |
| 首页 | `web/src/views/Home.vue` |
| 包列表 | `web/src/views/Packages.vue` |
| 包详情 | `web/src/views/PackageDetail.vue` |
| 登录 | `web/src/views/Login.vue` |
| 使用指南 | `web/src/views/Guide.vue` |
| 用户管理 | `web/src/views/admin/Users.vue` |
| 系统设置 | `web/src/views/admin/Settings.vue` |
| 管理后台 | `web/src/views/Admin.vue` |

### 基础设施文件

| 功能 | 文件路径 |
|------|----------|
| Docker 构建 | `Dockerfile` |
| Docker Compose | `docker-compose.yml` |
| CI 流水线 | `.github/workflows/ci.yml` |
| Docker 推送 | `.github/workflows/docker.yml` |
| Release 发布 | `.github/workflows/release.yml` |

---

## 五、按文件分类的功能清单

### cmd/grape/main.go
- 主入口，无优化项

### internal/server/server.go
- P0-29: 全局请求体大小限制 50MB ✅
- P1-35: 限流器优雅关闭 ✅
- P3-49: HTTP 安全响应头 ✅

### internal/config/config.go
- P0-27: AllowRegistration 配置 ✅

### internal/db/db.go, models.go
- P3-50: PackageVersion 联合唯一约束 ✅

### internal/auth/middleware.go
- P1-32: 移除 JWT query 参数 ✅

### internal/auth/user.go, db_user.go
- P1-30: GORM ErrRecordNotFound 修复 ✅
- P1-33: 密码复杂度验证 ✅
- P1-34: 角色白名单校验 ✅
- P2-39: MemoryUserStore 返回值拷贝 ✅

### internal/server/handler/auth.go
- P0-27: 开放注册逻辑 ✅
- P1-35: 限流器 Stop() ✅

### internal/server/handler/publish.go
- P0-28: 发布合并元数据 ✅
- P1-36: unpublish 权限检查 ✅
- P2-38: json.Marshal 错误处理 ✅
- P2-46: 发布锁清理 ✅

### internal/server/handler/registry.go
- P3-48: tarball URL 动态 baseURL ✅

### internal/storage/local/storage.go
- P0-26: 路径穿越攻击防护 ✅

### internal/registry/proxy.go
- P0-29: io.LimitReader 限制 ✅
- P2-37: URL 编码 ✅

### internal/web/embed.go
- P2-41: 文件句柄泄漏修复 ✅

### internal/webhook/webhook.go
- P0-22: Webhook 事件通知 ✅

### internal/metrics/metrics.go
- P0-24: Prometheus 监控 ✅

### web/src/api/index.ts
- 原始-1: JWT 注入 ✅
- 原始-2: 后端接口对接 ✅
- P2-44: 移除 console.error ✅

### web/src/router/index.ts
- P2-42: token 有效性验证 ✅
- P2-43: admin 角色检查 ✅

### web/src/stores/user.ts
- P2-43: role 状态管理 ✅

### web/src/views/Packages.vue
- P2-44: 移除 console.error ✅

### web/src/views/PackageDetail.vue
- P2-44: 移除 console.error ✅

### web/src/views/Login.vue
- P2-45: 重定向安全校验 ✅

### web/src/views/admin/Users.vue
- P3-47: 编辑功能对接 ✅

### Dockerfile, docker-compose.yml
- 原始-19: Docker 多阶段构建 ✅

### .github/workflows/
- 原始-20: CI/CD 流水线 ✅

---

## 六、待优化功能清单

| 编号 | 任务 | 优先级 | 说明 |
|------|------|--------|------|
| 31 | 全局 DB 变量改依赖注入 | P1 | 需重构 internal/db/db.go，涉及面广，暂缓 |
| 51 | 日志过滤敏感参数 | P3 | 可后续迭代实现 |

---

## 七、总结

### 完成度

- **原始25项**：21/25 完成（84%）
- **安全问题修复**：26/27 完成（96%）
- **长期优化**：5/6 完成（83%）

### 架构特点

1. **安全性**：路径穿越、开放注册、DoS 攻击、token 泄露等安全问题均已修复
2. **并发安全**：发布锁、内存用户存储、限流器均有保护
3. **可观测性**：Prometheus 监控 + 审计日志 + Webhook 完整
4. **部署友好**：Docker + CI/CD 完整支持

### 技术债务

- 全局 DB 变量（暂缓重构）
- 日志过滤（低优先级）

---

> **文档维护**：本文档整合了开发优化清单的三个版本，形成统一视图。如有新问题发现，请追加并注明发现时间。
