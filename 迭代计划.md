# ğŸ‡ Grape è¿­ä»£è®¡åˆ’

> å½“å‰ç›®æ ‡ï¼šè®©ä¸€ä¸ªç ”å‘å›¢é˜Ÿå¯ä»¥æ”¾å¿ƒåœ°åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Grape ä½œä¸ºç§æœ‰ npm ä»“åº“ã€‚
> ä¼ä¸šçº§ç‰¹æ€§ï¼ˆLDAPã€å¤šç§Ÿæˆ·ã€é›†ç¾¤ã€æ’ä»¶ç³»ç»Ÿï¼‰æ”¾åˆ°åç»­é˜¶æ®µï¼Œä¸æ˜¯å½“å‰é‡ç‚¹ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æ›´æ–°æ—¥æœŸ**: 2026-02-27

---

## å½“å‰çŠ¶æ€

### å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½ âœ…

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| npm publish / install / unpublish | æ ¸å¿ƒåè®®å…¼å®¹ |
| ç§æœ‰åŒ…å­˜å‚¨ + ä¸Šæ¸¸ä»£ç† | æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ |
| æŒ‰ scope è·¯ç”±å¤šä¸Šæ¸¸ | å¦‚ @company â†’ å†…ç½‘ï¼Œå…¶ä»– â†’ npmjs |
| ç”¨æˆ·ç®¡ç†ï¼ˆåˆ›å»º/ç¼–è¾‘/åˆ é™¤ï¼‰ | ç®¡ç†åå° + API |
| è§’è‰²æƒé™ï¼ˆadmin / developer / readonlyï¼‰ | åŸºäºè§’è‰²çš„å…¨å±€æ§åˆ¶ |
| JWT è®¤è¯ | ç™»å½•åé¢å‘ token |
| é…ç½®çƒ­æ›´æ–° | ä¿®æ”¹é…ç½®æ— éœ€é‡å¯ |
| å®¡è®¡æ—¥å¿— | ç™»å½•/å‘å¸ƒ/åˆ é™¤ç­‰æ“ä½œè®°å½• |
| Webhook äº‹ä»¶é€šçŸ¥ | package:published ç­‰äº‹ä»¶æ¨é€ |
| Prometheus ç›‘æ§æŒ‡æ ‡ | /metrics ç«¯ç‚¹ |
| Docker éƒ¨ç½² | Dockerfile + docker-compose.yml |
| Web UI | åŒ…åˆ—è¡¨ã€è¯¦æƒ…ã€ç®¡ç†åå° |

### ä¸ Verdaccio çš„å®¢è§‚å·®è·

| å·®è·é¡¹ | å½±å“ | ä¼˜å…ˆçº§ |
|--------|------|--------|
| **CI/CD Token** â€” æ— æŒä¹…åŒ– tokenï¼Œæµæ°´çº¿æ— æ³•è‡ªåŠ¨å‘å¸ƒ | ç›´æ¥é˜»å¡ CI ä½¿ç”¨ | ğŸ”´ P0 |
| **æ•°æ®å¤‡ä»½** â€” æ— å¤‡ä»½/æ¢å¤å·¥å…·ï¼Œä¸Šç”Ÿäº§æœ‰é¡¾è™‘ | æ•°æ®å®‰å…¨ | ğŸ”´ P0 |
| **åŒ…çº§åˆ« ACL** â€” ä»»æ„ developer å¯è¦†ç›–ä»–äººçš„åŒ… | ç¨å¤§å›¢é˜Ÿä¼šé‡åˆ° | ğŸŸ¡ P1 |
| LDAP/AD é›†æˆ | æœ‰ AD çš„ä¼ä¸šå¿…é¡»è¦ | ğŸŸ¡ P1ï¼ˆæš‚ç¼“ï¼‰ |
| S3/OSS å­˜å‚¨ | äº‘éƒ¨ç½²å¤§è§„æ¨¡å­˜å‚¨ | ğŸŸ¢ P2 |
| é›†ç¾¤ / é«˜å¯ç”¨ | å¤šå®ä¾‹éƒ¨ç½² | ğŸŸ¢ P2 |
| æ’ä»¶ç³»ç»Ÿ | å®šåˆ¶æ‰©å±• | ğŸŸ¢ P2 |

---

## Phase 1ï¼šå›¢é˜Ÿå¯ç”¨ï¼ˆå½“å‰ç›®æ ‡ï¼‰

**å®Œæˆæ ‡å‡†**ï¼šå›¢é˜Ÿèƒ½åœ¨ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œï¼ŒCI/CD æµæ°´çº¿æ­£å¸¸å·¥ä½œï¼Œæ•°æ®æœ‰å¤‡ä»½ä¿éšœã€‚

---

### T1 Â· CI/CD Token ç®¡ç† ğŸ”´ ä¼˜å…ˆçº§æœ€é«˜

**èƒŒæ™¯**ï¼šå½“å‰ JWT æ˜¯æ¯æ¬¡ `npm login` é¢å‘çš„çŸ­æœŸ tokenï¼ŒCI ç¯å¢ƒä¸èƒ½äº¤äº’å¼ç™»å½•ã€‚
Verdaccio æ”¯æŒ `npm token create` ç”ŸæˆæŒä¹…åŒ– tokenï¼Œè¿™æ˜¯ CI/CD åœºæ™¯çš„åˆšéœ€ã€‚

**å®ç°æ–¹æ¡ˆ**ï¼š

æ•°æ®åº“æ–°å¢ `tokens` è¡¨ï¼š
```go
type Token struct {
    ID        uint      `gorm:"primaryKey"`
    UserID    uint      `gorm:"index"`
    Name      string    `gorm:"size:100"`      // æè¿°ï¼Œå¦‚ "github-ci"
    Token     string    `gorm:"size:255;uniqueIndex"` // sha256 å“ˆå¸Œå­˜å‚¨
    Readonly  bool                              // åªè¯» token ä¸èƒ½å‘å¸ƒ
    ExpiresAt *time.Time                        // nil = æ°¸ä¸è¿‡æœŸ
    LastUsed  *time.Time
    CreatedAt time.Time
}
```

åç«¯ APIï¼š
```
POST   /-/npm/v1/tokens          åˆ›å»º token
GET    /-/npm/v1/tokens          åˆ—å‡ºå½“å‰ç”¨æˆ·çš„ token
DELETE /-/npm/v1/tokens/token/:id æ’¤é”€ token
```

è®¤è¯ä¸­é—´ä»¶æ”¹åŠ¨ï¼šå…ˆæ£€æŸ¥ Bearer JWTï¼Œå†æ£€æŸ¥ Token è¡¨ï¼ˆå…¼å®¹ç°æœ‰æµç¨‹ï¼‰ã€‚

å‰ç«¯ï¼šç”¨æˆ·ä¸ªäººé¡µé¢å¢åŠ  Token ç®¡ç†ï¼ˆåˆ—è¡¨ + åˆ›å»º + æ’¤é”€ï¼‰ã€‚

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `npm token create` æ­£å¸¸å·¥ä½œ
- [ ] `npm token list` åˆ—å‡ºæ‰€æœ‰ token
- [ ] `npm token revoke <id>` æ’¤é”€ç”Ÿæ•ˆ
- [ ] åªè¯» token å‘å¸ƒæ—¶è¿”å› 403
- [ ] CI æµæ°´çº¿ï¼ˆGitHub Actions / GitLab CIï¼‰å¯ä»¥ç”¨ token å‘åŒ…

**å·¥ä½œé‡ä¼°è®¡**ï¼š3-4 å¤©

---

### T2 Â· æ•°æ®å¤‡ä»½ä¸æ¢å¤ ğŸ”´ ä¼˜å…ˆçº§æ¬¡é«˜

**èƒŒæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»æœ‰æ•°æ®ä¿æŠ¤ã€‚Grape çš„æ•°æ®å°±ä¸¤éƒ¨åˆ†ï¼šSQLite æ–‡ä»¶ + åŒ…æ–‡ä»¶ç›®å½•ã€‚

**å®ç°æ–¹æ¡ˆ**ï¼šåœ¨ `grape` äºŒè¿›åˆ¶ä¸­å¢åŠ å­å‘½ä»¤ï¼Œä¸ä¾èµ–å¤–éƒ¨å·¥å…·ã€‚

```bash
# å¤‡ä»½ï¼ˆæ‰“åŒ… SQLite + packages/ ç›®å½•ä¸º tar.gzï¼‰
grape backup --output ./backup/grape-20260227.tar.gz

# æ¢å¤
grape restore --input ./backup/grape-20260227.tar.gz

# æŸ¥çœ‹å¤‡ä»½å†…å®¹
grape backup --list --input ./backup/grape-20260227.tar.gz
```

å¤‡ä»½å†…å®¹ï¼š
- `data/grape.db`ï¼ˆSQLite æ•°æ®åº“ï¼‰
- `data/packages/`ï¼ˆæ‰€æœ‰åŒ…æ–‡ä»¶ï¼‰
- å½“å‰ `configs/config.yaml`ï¼ˆæ–¹ä¾¿æ¢å¤æ—¶å¯¹ç…§é…ç½®ï¼‰

é…å¥—æ–‡æ¡£ï¼šæä¾› cron å®šæ—¶å¤‡ä»½ç¤ºä¾‹ã€‚

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `grape backup` ç”Ÿæˆå®Œæ•´å‹ç¼©åŒ…
- [ ] `grape restore` æ¢å¤åæœåŠ¡æ­£å¸¸
- [ ] å¤‡ä»½æ–‡ä»¶åŒ…å« db + åŒ…æ–‡ä»¶ + é…ç½®å¿«ç…§
- [ ] æ–‡æ¡£ä¸­æœ‰ cron ç¤ºä¾‹

**å·¥ä½œé‡ä¼°è®¡**ï¼š1-2 å¤©

---

### T3 Â· åŒ…çº§åˆ«è®¿é—®æ§åˆ¶ï¼ˆç®€åŒ– ACLï¼‰ ğŸŸ¡ å¯åœ¨ T1/T2 å®Œæˆååš

**èƒŒæ™¯**ï¼šå½“å‰ä»»æ„ developer éƒ½èƒ½å‘å¸ƒ/è¦†ç›–ä»»ä½•åŒ…ã€‚å¯¹äºæœ‰å¤šä¸ªå°ç»„å…±ç”¨ä¸€ä¸ª registry çš„å›¢é˜Ÿï¼Œéœ€è¦æ§åˆ¶"åªæœ‰å‰ç«¯ç»„èƒ½å‘ @ui/*"ã€‚

**ç®€åŒ–æ–¹æ¡ˆ**ï¼ˆä¸åšå¤æ‚çš„ ACL ç³»ç»Ÿï¼Œå¤Ÿç”¨å°±è¡Œï¼‰ï¼š

æ•°æ®åº“æ–°å¢ `package_owners` è¡¨ï¼š
```go
type PackageOwner struct {
    PackageName string `gorm:"primaryKey;size:255"` // æ”¯æŒé€šé…ç¬¦ @ui/*
    Username    string `gorm:"primaryKey;size:100"`
    CanPublish  bool
}
```

è§„åˆ™ï¼š
1. åŒ…ç¬¬ä¸€æ¬¡å‘å¸ƒæ—¶ï¼Œå‘å¸ƒè€…è‡ªåŠ¨æˆä¸º owner
2. owner å¯ä»¥é€šè¿‡ `npm owner add/rm` ç®¡ç†å…¶ä»– owner
3. admin å¯ä»¥ç®¡ç†æ‰€æœ‰åŒ…çš„ owner
4. æ²¡æœ‰ owner é™åˆ¶çš„åŒ…ä»»ä½• developer éƒ½å¯ä»¥å‘å¸ƒï¼ˆå‘åå…¼å®¹ï¼‰

API å…¼å®¹ npm åè®®ï¼š
```
GET  /-/package/:name/collaborators  åˆ—å‡ºåŒ…çš„ owner
PUT  /-/org/:scope/team/:team/package æ·»åŠ  ownerï¼ˆç®€åŒ–å®ç°ï¼‰
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] å‘å¸ƒæ–°åŒ…è‡ªåŠ¨è®¾ä¸º owner
- [ ] é owner å‘å¸ƒå·²æœ‰åŒ…è¿”å› 403
- [ ] admin å¯ä»¥åœ¨åå°ç®¡ç†åŒ… owner
- [ ] `npm owner add/rm` å‘½ä»¤å¯ç”¨

**å·¥ä½œé‡ä¼°è®¡**ï¼š3-5 å¤©

---

## Phase 2ï¼šè¿ç»´å¢å¼ºï¼ˆå›¢é˜Ÿç¨³å®šè¿è¡Œåï¼‰

è¿™äº›åŠŸèƒ½ä¸å½±å“åŸºæœ¬ä½¿ç”¨ï¼Œä½†èƒ½æå‡è¿ç»´ä½“éªŒï¼ŒæŒ‰éœ€æ¨è¿›ã€‚

| åŠŸèƒ½ | è¯´æ˜ | å·¥ä½œé‡ |
|------|------|--------|
| **LDAP/AD é›†æˆ** | ä¼ä¸šå·²æœ‰è´¦å·ç³»ç»Ÿçš„å›¢é˜Ÿéœ€è¦ | 3-5 å¤© |
| **Helm Chart** | k8s ç¯å¢ƒéƒ¨ç½² | 2-3 å¤© |
| **åŒ…æ¸…ç† (GC)** | æ¸…ç†æœªå¼•ç”¨çš„æ—§ç‰ˆæœ¬å’Œå­¤ç«‹ tarball | 2-3 å¤© |
| **S3/OSS å­˜å‚¨** | æ›¿ä»£æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œäº‘éƒ¨ç½²å¿…è¦ | 3-5 å¤© |
| **Redis å…ƒæ•°æ®ç¼“å­˜** | é«˜å¹¶å‘åœºæ™¯æ€§èƒ½ä¼˜åŒ– | 3-5 å¤© |

---

## Phase 3ï¼šä¼ä¸šç‰¹æ€§ï¼ˆæš‚ç¼“ï¼‰

ä»¥ä¸‹åŠŸèƒ½æš‚ä¸åœ¨è®¡åˆ’å†…ï¼Œç­‰å›¢é˜Ÿè§„æ¨¡å’Œéœ€æ±‚æ˜ç¡®åå†è¯„ä¼°ã€‚

- å¤šç§Ÿæˆ·æ”¯æŒ
- æ’ä»¶ç³»ç»Ÿ
- åŒ…å®‰å…¨æ¼æ´æ‰«æ
- é›†ç¾¤ / é«˜å¯ç”¨éƒ¨ç½²
- SAML / OIDC
- å•†ä¸šåŒ–åŠŸèƒ½

---

## å½“å‰è¡ŒåŠ¨é¡¹

```
Now  â†’  T1 CI/CD Tokenï¼ˆ3-4å¤©ï¼‰
Then â†’  T2 å¤‡ä»½å·¥å…·ï¼ˆ1-2å¤©ï¼‰
Then â†’  T3 åŒ…çº§åˆ« ACLï¼ˆ3-5å¤©ï¼‰

å®Œæˆä»¥ä¸Šä¸‰é¡¹åï¼ŒGrape æ»¡è¶³å›¢é˜Ÿç”Ÿäº§ä½¿ç”¨æ ‡å‡†ã€‚
```

---

## å‚è€ƒï¼šnpm Token å·¥ä½œæµç¤ºä¾‹

```bash
# å¼€å‘è€…æœ¬åœ°ï¼šç”¨è´¦å·å¯†ç ç™»å½•ï¼Œè·å¾—çŸ­æœŸ JWT
npm login --registry http://your-grape-server

# CI ç¯å¢ƒï¼šç”¨æŒä¹…åŒ– tokenï¼ˆä¸éœ€è¦äº¤äº’ï¼‰
npm config set //your-grape-server/:_authToken ${GRAPE_TOKEN}
npm publish
```

GitHub Actions ç¤ºä¾‹ï¼š
```yaml
- name: Publish to Grape
  env:
    GRAPE_TOKEN: ${{ secrets.GRAPE_TOKEN }}
  run: |
    npm config set //grape.company.com/:_authToken $GRAPE_TOKEN
    npm publish
```
