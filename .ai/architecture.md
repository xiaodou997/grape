# ğŸ—ï¸ Grape Registry - ç³»ç»Ÿæ¶æ„æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-02-27  
**ç›®æ ‡è¯»è€…**: æ¶æ„å¸ˆã€é«˜çº§å¼€å‘è€…ã€AI åŠ©æ‰‹

---

## ğŸ“ æ€»ä½“æ¶æ„

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Layer                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Browser    â”‚  â”‚  npm/yarn/   â”‚  â”‚   Management Client     â”‚  â”‚
â”‚  â”‚   (Web UI)   â”‚  â”‚  pnpm/bun    â”‚  â”‚   (API Consumer)        â”‚  â”‚
â”‚  â”‚   Port 4873  â”‚  â”‚   Port 4874  â”‚  â”‚   Port 4873/4874        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HTTP Server Layer (Gin)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Web UI Router            â”‚  â”‚   Registry API Router        â”‚ â”‚
â”‚  â”‚   - Static Files (FS)      â”‚  â”‚   - GET /:package            â”‚ â”‚
â”‚  â”‚   - Admin API (/-/api/*)   â”‚  â”‚   - PUT /:package            â”‚ â”‚
â”‚  â”‚   - Health (/-/health)     â”‚  â”‚   - DELETE /:package         â”‚ â”‚
â”‚  â”‚   - Metrics (/-/metrics)   â”‚  â”‚   - GET /:package/*filepath  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Business Logic Layer (Handler)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Auth    â”‚ â”‚ Registry â”‚ â”‚ Publish  â”‚ â”‚  Token   â”‚ â”‚  Owner   â”‚ â”‚
â”‚  â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Webhook  â”‚ â”‚  Backup  â”‚ â”‚    GC    â”‚ â”‚   API    â”‚ â”‚  Audit   â”‚ â”‚
â”‚  â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Infrastructure Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Proxy      â”‚  â”‚   Storage    â”‚  â”‚      Database            â”‚ â”‚
â”‚  â”‚  (Upstream   â”‚  â”‚  (Local FS)  â”‚  â”‚      (SQLite + GORM)     â”‚ â”‚
â”‚  â”‚   Cache)     â”‚  â”‚              â”‚  â”‚                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚   Webhook    â”‚  â”‚   Metrics    â”‚                              â”‚
â”‚  â”‚ Dispatcher   â”‚  â”‚ (Prometheus) â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¢ åˆ†å±‚ç»“æ„

### 1. è¡¨ç°å±‚ï¼ˆPresentation Layerï¼‰

**åŒ…è·¯å¾„**: `internal/server/`

| ç»„ä»¶ | èŒè´£ | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| **Router** | HTTP è·¯ç”±åˆ†å‘ | `server.go` |
| **Middleware** | è®¤è¯ã€é™æµã€æ—¥å¿— | `server.go`, `auth/middleware.go` |
| **Handler** | è¯·æ±‚å¤„ç†ã€å“åº”å°è£… | `handler/*.go` |

**è®¾è®¡æ¨¡å¼**:
- **Front Controller**: Gin ç»Ÿä¸€å…¥å£
- **Middleware Chain**: è´£ä»»é“¾æ¨¡å¼å¤„ç†è®¤è¯ã€æ—¥å¿—ã€é™æµ
- **Handler Mapping**: è·¯ç”±åˆ°å…·ä½“ Handler æ–¹æ³•

### 2. ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆBusiness Logic Layerï¼‰

**åŒ…è·¯å¾„**: `internal/auth/`, `internal/registry/`, `internal/webhook/`

| æ¨¡å— | èŒè´£ | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| **Auth** | ç”¨æˆ·è®¤è¯ã€JWT ç®¡ç† | `auth/jwt.go`, `auth/middleware.go` |
| **Registry** | npm åè®®å®ç°ã€ä¸Šæ¸¸ä»£ç† | `registry/proxy.go` |
| **Webhook** | äº‹ä»¶é€šçŸ¥ã€é‡è¯•æœºåˆ¶ | `webhook/webhook.go` |

**è®¾è®¡æ¨¡å¼**:
- **Service Layer**: å°è£…æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **Proxy**: ä¸Šæ¸¸ä»£ç†ç¼“å­˜
- **Strategy**: å¤šä¸Šæ¸¸è·¯ç”±ç­–ç•¥

### 3. æ•°æ®è®¿é—®å±‚ï¼ˆData Access Layerï¼‰

**åŒ…è·¯å¾„**: `internal/db/`, `internal/storage/`

| ç»„ä»¶ | èŒè´£ | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| **DB** | SQLite + GORM ORM | `db/db.go`, `db/models.go` |
| **Storage** | æ–‡ä»¶ç³»ç»ŸæŠ½è±¡ | `storage/storage.go`, `storage/local/storage.go` |

**è®¾è®¡æ¨¡å¼**:
- **Repository**: GORM å°è£…æ•°æ®è®¿é—®
- **Active Record**: æ¨¡å‹è‡ªå¸¦ CRUD æ–¹æ³•
- **Storage Interface**: å­˜å‚¨å±‚æ¥å£æŠ½è±¡

### 4. åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructure Layerï¼‰

**åŒ…è·¯å¾„**: `internal/config/`, `internal/logger/`, `internal/metrics/`

| ç»„ä»¶ | èŒè´£ | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| **Config** | é…ç½®åŠ è½½ã€çƒ­æ›´æ–° | `config/config.go`, `config/loader.go` |
| **Logger** | ç»“æ„åŒ–æ—¥å¿— | `logger/logger.go` |
| **Metrics** | Prometheus æŒ‡æ ‡ | `metrics/metrics.go` |

**è®¾è®¡æ¨¡å¼**:
- **Singleton**: å…¨å±€é…ç½®ã€æ—¥å¿—å®ä¾‹
- **Observer**: Viper é…ç½®çƒ­æ›´æ–°ç›‘å¬

---

## ğŸ“¦ æ¨¡å—åˆ’åˆ†

### æ ¸å¿ƒæ¨¡å—ä¾èµ–å…³ç³»

```
cmd/grape/main.go
    â”‚
    â”œâ”€â”€ internal/config        # é…ç½®ç®¡ç†
    â”œâ”€â”€ internal/db            # æ•°æ®åº“
    â”œâ”€â”€ internal/logger        # æ—¥å¿—
    â”‚
    â””â”€â”€ internal/server        # HTTP æœåŠ¡å™¨
            â”‚
            â”œâ”€â”€ internal/auth        # è®¤è¯
            â”œâ”€â”€ internal/registry    # Registry æ ¸å¿ƒ
            â”œâ”€â”€ internal/storage     # å­˜å‚¨
            â”œâ”€â”€ internal/webhook     # Webhook
            â”œâ”€â”€ internal/metrics     # æŒ‡æ ‡
            â”‚
            â””â”€â”€ handler/             # HTTP Handler
                    â”œâ”€â”€ api.go           # ç®¡ç† API
                    â”œâ”€â”€ auth.go          # è®¤è¯ API
                    â”œâ”€â”€ publish.go       # å‘å¸ƒ API
                    â”œâ”€â”€ registry.go      # Registry API
                    â”œâ”€â”€ token.go         # Token API
                    â”œâ”€â”€ owner.go         # Owner API
                    â”œâ”€â”€ webhook.go       # Webhook API
                    â”œâ”€â”€ backup.go        # å¤‡ä»½ API
                    â”œâ”€â”€ gc.go            # GC API
                    â””â”€â”€ audit.go         # å®¡è®¡ API
```

### æ¨¡å—èŒè´£è¯´æ˜

| æ¨¡å— | èŒè´£ | å…³é”®æ¥å£/ç»“æ„ |
|------|------|---------------|
| **config** | é…ç½®åŠ è½½ã€éªŒè¯ã€çƒ­æ›´æ–° | `Config`, `Load()`, `WatchConfig()` |
| **db** | æ•°æ®åº“è¿æ¥ã€ORMã€è¿ç§» | `DB`, `Init()`, `Migrate()` |
| **auth** | JWT ç”Ÿæˆ/éªŒè¯ã€ç”¨æˆ·è®¤è¯ | `JWTService`, `AuthMiddleware()` |
| **registry** | npm åè®®å®ç°ã€ä¸Šæ¸¸ä»£ç† | `Proxy`, `GetMetadata()` |
| **storage** | åŒ…æ–‡ä»¶å­˜å‚¨æŠ½è±¡ | `Storage` interface, `SavePackage()` |
| **webhook** | äº‹ä»¶é€šçŸ¥ã€é‡è¯• | `Dispatcher`, `Dispatch()` |
| **metrics** | Prometheus æŒ‡æ ‡æ”¶é›† | `Metrics`, `RecordRequest()` |
| **server** | HTTP æœåŠ¡å™¨ã€è·¯ç”± | `Server`, `Start()`, `Shutdown()` |
| **handler** | HTTP è¯·æ±‚å¤„ç† | `RegistryHandler`, `PublishHandler` |

---

## ğŸ”„ æ•°æ®æµè¯´æ˜

### 1. åŒ…ä¸‹è½½æµç¨‹

```
npm install lodash
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP GET /lodash â”‚  (Port 4874)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Registry Handler.GetPackage()      â”‚
â”‚  1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜                     â”‚
â”‚  2. ç¼“å­˜å‘½ä¸­ â†’ è¿”å›                  â”‚
â”‚  3. ç¼“å­˜æœªå‘½ä¸­ â†’ ä»£ç†ä¸Šæ¸¸            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Proxy.GetMetadata()                â”‚
â”‚  1. é€‰æ‹©ä¸Šæ¸¸ï¼ˆæŒ‰ scope è·¯ç”±ï¼‰           â”‚
â”‚  2. HTTP GET ä¸Šæ¸¸ URL                 â”‚
â”‚  3. è§£å‹ gzipï¼ˆå¦‚æœ‰ï¼‰                â”‚
â”‚  4. éªŒè¯ JSON å®Œæ•´æ€§                  â”‚
â”‚  5. åŸå­å†™å…¥æœ¬åœ°å­˜å‚¨                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response: package metadata (JSON)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. åŒ…å‘å¸ƒæµç¨‹

```
npm publish my-package
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP PUT /my-package  â”‚  (Port 4874)
â”‚  Body: package.json    â”‚
â”‚        + tarball       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Publish Handler.Publish()          â”‚
â”‚  1. éªŒè¯è®¤è¯ï¼ˆJWT/Tokenï¼‰            â”‚
â”‚  2. éªŒè¯åŒ…ååˆæ³•æ€§                   â”‚
â”‚  3. æ£€æŸ¥æƒé™ï¼ˆOwner ACLï¼‰            â”‚
â”‚  4. è§£æè¯·æ±‚ä½“                       â”‚
â”‚  5. åˆå¹¶å…ƒæ•°æ®                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Storage.SavePackage()              â”‚
â”‚  1. éªŒè¯ JSON å®Œæ•´æ€§                   â”‚
â”‚  2. åŸå­å†™å…¥ï¼ˆä¸´æ—¶æ–‡ä»¶ â†’ é‡å‘½åï¼‰     â”‚
â”‚  3. æ›´æ–°æ•°æ®åº“ï¼ˆPackageVersionï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Webhook Dispatch()                 â”‚
â”‚  Event: package:published           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response: 201 Created              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. è®¤è¯æµç¨‹

```
HTTP Request with Authorization header
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthMiddleware()                   â”‚
â”‚  1. è§£æ Bearer Token                â”‚
â”‚  2. ä¼˜å…ˆéªŒè¯ JWT                     â”‚
â”‚  3. JWT å¤±è´¥ â†’ éªŒè¯æŒä¹…åŒ– Token        â”‚
â”‚  4. éƒ½å¤±è´¥ â†’ æ”¾è¡Œï¼ˆå¯é€‰è®¤è¯ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context.Set("user", user)          â”‚
â”‚  Context.Set("token", tokenInfo)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Handler ä¸šåŠ¡é€»è¾‘                    â”‚
â”‚  RequireAuth() / RequireAdmin()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æƒé™æ¨¡å‹

### è§’è‰²å®šä¹‰

| è§’è‰² | æƒé™ | è¯´æ˜ |
|------|------|------|
| **admin** | å…¨éƒ¨æƒé™ | ç³»ç»Ÿç®¡ç†å‘˜ |
| **developer** | å‘å¸ƒåŒ…ã€ç®¡ç†è‡ªå·±çš„åŒ… | æ™®é€šå¼€å‘è€… |
| **readonly** | ä»…è¯»å– | åªè¯»ç”¨æˆ· |

### æƒé™æ£€æŸ¥ç‚¹

| æ“ä½œ | æ‰€éœ€è§’è‰² | å®ç°ä½ç½® |
|------|----------|----------|
| `GET /:package` | ä»»æ„ï¼ˆå…¬å¼€ï¼‰ | æ— æ£€æŸ¥ |
| `PUT /:package` | developer+ | `RequireAuth()` |
| `DELETE /:package` | admin æˆ– owner | `RequireAuth()` + Owner æ£€æŸ¥ |
| `GET /-/api/admin/*` | admin | `RequireAdmin()` |
| `POST /-/api/admin/users` | admin | `RequireAdmin()` |
| `PUT /-/api/admin/config` | admin | `RequireAdmin()` |

### Token ç±»å‹

| Token ç±»å‹ | ç”¨é€” | æƒé™ |
|------------|------|------|
| **JWT** | ç”¨æˆ·ç™»å½•é¢å‘ | çŸ­æœŸï¼ˆ24hï¼‰ï¼Œå®Œæ•´æƒé™ |
| **Persistent Token** | CI/CD è‡ªåŠ¨åŒ– | é•¿æœŸï¼Œå¯è®¾ç½®åªè¯» |

---

## ğŸ’¾ ç¼“å­˜æœºåˆ¶

### ä¸Šæ¸¸ä»£ç†ç¼“å­˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Proxy.GetMetadata(packageName)        â”‚
â”‚                                         â”‚
â”‚  1. æ£€æŸ¥æœ¬åœ°å­˜å‚¨                         â”‚
â”‚     â””â”€ å‘½ä¸­ â†’ è¿”å›                      â”‚
â”‚     â””â”€ æœªå‘½ä¸­ â†’ ç»§ç»­                    â”‚
â”‚                                         â”‚
â”‚  2. é€‰æ‹©ä¸Šæ¸¸ï¼ˆæŒ‰ scope è·¯ç”±ï¼‰              â”‚
â”‚     â””â”€ @company/* â†’ company-private     â”‚
â”‚     â””â”€ @internal/* â†’ internal-tools     â”‚
â”‚     â””â”€ å…¶ä»– â†’ npmjsï¼ˆé»˜è®¤ï¼‰             â”‚
â”‚                                         â”‚
â”‚  3. HTTP GET ä¸Šæ¸¸ URL                     â”‚
â”‚     â””â”€ Accept-Encoding: gzip            â”‚
â”‚     â””â”€ Timeout: 30s                     â”‚
â”‚                                         â”‚
â”‚  4. å¤„ç†å“åº”                             â”‚
â”‚     â””â”€ è§£å‹ gzipï¼ˆå¦‚æœ‰ï¼‰                â”‚
â”‚     â””â”€ éªŒè¯ JSON å®Œæ•´æ€§                   â”‚
â”‚     â””â”€ é™åˆ¶å¤§å°ï¼ˆmaxMetadataSize=50MBï¼‰ â”‚
â”‚                                         â”‚
â”‚  5. åŸå­å†™å…¥æœ¬åœ°å­˜å‚¨                     â”‚
â”‚     â””â”€ å†™ä¸´æ—¶æ–‡ä»¶                        â”‚
â”‚     â””â”€ é‡å‘½åï¼ˆåŸå­æ“ä½œï¼‰               â”‚
â”‚                                         â”‚
â”‚  6. è¿”å›å…ƒæ•°æ®                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼“å­˜ç­–ç•¥

| ç­–ç•¥ | è¯´æ˜ |
|------|------|
| **Cache-Through** | ç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨ä»ä¸Šæ¸¸åŠ è½½ |
| **Write-Through** | å‘å¸ƒåŒ…æ—¶åŒæ­¥å†™å…¥ç¼“å­˜ |
| **No Expiration** | ç¼“å­˜æ°¸ä¸è¿‡æœŸï¼ˆæ‰‹åŠ¨æ¸…ç†ï¼‰ |
| **Atomic Write** | åŸå­å†™å…¥é¿å…æŸå |

---

## ğŸ“¡ æ‰©å±•æ€§åˆ†æ

### å½“å‰é™åˆ¶

| é™åˆ¶ | å½±å“ | æ”¹è¿›æ–¹å‘ |
|------|------|----------|
| **å• SQLite æ–‡ä»¶** | å¹¶å‘å†™å…¥é”ç«äº‰ | PostgreSQL æ”¯æŒ |
| **æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ** | æ— æ³•æ°´å¹³æ‰©å±• | S3/OSS å¯¹è±¡å­˜å‚¨ |
| **å•å®ä¾‹éƒ¨ç½²** | æ— é«˜å¯ç”¨ | å¤šå®ä¾‹ + å…±äº«å­˜å‚¨ |
| **åŒæ­¥ Webhook** | å¯èƒ½é˜»å¡è¯·æ±‚ | å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ— |

### æ‰©å±•ç‚¹

| æ‰©å±•ç‚¹ | æ¥å£/æŠ½è±¡ | å®ç°éš¾åº¦ |
|--------|-----------|----------|
| **å­˜å‚¨å±‚** | `storage.Storage` æ¥å£ | ğŸŸ¢ ä½ï¼ˆå·²æœ‰æŠ½è±¡ï¼‰ |
| **æ•°æ®åº“** | `db.DB` GORM æŠ½è±¡ | ğŸŸ¡ ä¸­ï¼ˆéœ€è¿ç§»è„šæœ¬ï¼‰ |
| **è®¤è¯** | `auth.UserStore` æ¥å£ | ğŸŸ¢ ä½ï¼ˆå·²æœ‰æŠ½è±¡ï¼‰ |
| **ä¸Šæ¸¸è·¯ç”±** | `registry.Proxy` | ğŸŸ¢ ä½ï¼ˆé…ç½®é©±åŠ¨ï¼‰ |

---

## ğŸ”§ é‡æ„å»ºè®®

### çŸ­æœŸé‡æ„ï¼ˆ1-2 å‘¨ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | æ”¶ç›Š |
|------|--------|------|
| **ä¿®å¤åŒç«¯å£è·¯ç”±** | ğŸ”´ P0 | æœåŠ¡å¯å¯åŠ¨ |
| **ç®€åŒ–è·¯ç”±é€»è¾‘** | ğŸŸ¡ P1 | æé«˜å¯æµ‹è¯•æ€§ |
| **ç»Ÿä¸€é”™è¯¯å¤„ç†** | ğŸŸ¡ P1 | ä»£ç ä¸€è‡´æ€§ |

### ä¸­æœŸé‡æ„ï¼ˆ1-2 æœˆï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | æ”¶ç›Š |
|------|--------|------|
| **å¼•å…¥ Service å±‚** | ğŸŸ¡ P2 | ä¸šåŠ¡é€»è¾‘å¤ç”¨ |
| **å¼‚æ­¥ Webhook** | ğŸŸ¡ P2 | æ€§èƒ½æå‡ |
| **PostgreSQL æ”¯æŒ** | ğŸŸ¡ P2 | å¹¶å‘èƒ½åŠ›æå‡ |

### é•¿æœŸé‡æ„ï¼ˆ3-6 æœˆï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | æ”¶ç›Š |
|------|--------|------|
| **S3 å­˜å‚¨æ”¯æŒ** | ğŸŸ¢ P3 | äº‘åŸç”Ÿéƒ¨ç½² |
| **å¤šå®ä¾‹é›†ç¾¤** | ğŸŸ¢ P3 | é«˜å¯ç”¨ |
| **æ’ä»¶ç³»ç»Ÿ** | ğŸŸ¢ P3 | ç”Ÿæ€æ‰©å±• |

---

## ğŸ—ºï¸ ASCII æ¶æ„å›¾

### å®Œæ•´æ¶æ„

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚     Clients     â”‚
                         â”‚  npm/browser/   â”‚
                         â”‚     API         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Load Balancer (å¯é€‰)   â”‚
                    â”‚   nginx / caddy         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                             â”‚
              â–¼                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Web UI Server  â”‚           â”‚  Registry API   â”‚
    â”‚   Port 4873     â”‚           â”‚   Port 4874     â”‚
    â”‚                 â”‚           â”‚                 â”‚
    â”‚  Gin Router     â”‚           â”‚  Gin Router     â”‚
    â”‚  - Static FS    â”‚           â”‚  - GET /:pkg    â”‚
    â”‚  - Admin API    â”‚           â”‚  - PUT /:pkg    â”‚
    â”‚  - Health       â”‚           â”‚  - DELETE /:pkg â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                             â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Business Logic    â”‚
                  â”‚   (Handler Layer)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Auth Service  â”‚ â”‚ Registry  â”‚ â”‚   Webhook    â”‚
    â”‚  (JWT + Token) â”‚ â”‚  Service  â”‚ â”‚  Dispatcher  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Database     â”‚ â”‚  Storage  â”‚ â”‚    Metrics   â”‚
    â”‚   (SQLite)     â”‚ â”‚  (Local)  â”‚ â”‚  (Prometheus)â”‚
    â”‚                â”‚ â”‚           â”‚ â”‚              â”‚
    â”‚ - users        â”‚ â”‚ - packages/â”‚ â”‚ - requests   â”‚
    â”‚ - packages     â”‚ â”‚ - tarballs â”‚ â”‚ - latency    â”‚
    â”‚ - tokens       â”‚ â”‚            â”‚ â”‚ - errors     â”‚
    â”‚ - audit_logs   â”‚ â”‚            â”‚ â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**æœ€åæ›´æ–°**: 2026-02-27  
**ä¸‹æ¬¡å®¡æŸ¥**: æ¶æ„é‡å¤§å˜æ›´æ—¶æ›´æ–°
