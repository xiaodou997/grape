# 🍇 Grape Registry - 项目上下文

**文档版本**: v1.0  
**最后更新**: 2026-02-27  
**维护者**: Grape Team  
**目标读者**: 新加入的开发者、AI 助手、技术决策者

---

## 📌 项目目标

构建一个**轻量级、高性能、企业级**的私有 npm 仓库，替代 Verdaccio，满足研发团队对私有包管理和上游代理的需求。

### 核心设计原则

1. **单一二进制** - 无需 Node.js 运行时，一个二进制文件即可运行
2. **零配置启动** - 默认配置即可使用，无需复杂配置
3. **npm 兼容** - 完整兼容 npm/yarn/pnpm/bun 客户端
4. **低资源占用** - 内存占用 < 10MB，远低于 Verdaccio（~50MB）
5. **数据持久化** - SQLite 存储，重启不丢失数据
6. **双端口分离** - Web UI（4873）与 Registry API（4874）独立监听

---

## 🎯 产品定位

| 维度 | 定位 |
|------|------|
| **目标用户** | 中小研发团队、个人开发者 |
| **使用场景** | 私有包管理、公共包缓存加速、多上游路由 |
| **竞争对手** | Verdaccio、Sonatype Nexus、Artifactory |
| **差异化优势** | 更轻量、更简单、双端口分离、Go 语言编写 |

---

## 🛠️ 技术栈总览

### 后端技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **语言** | Go | 1.25.0 | 后端主语言 |
| **Web 框架** | Gin | v1.11.0 | HTTP 服务器 |
| **ORM** | GORM | v1.31.1 | 数据库操作 |
| **数据库** | SQLite | v1.14.22 | 数据持久化 |
| **配置** | Viper | v1.21.0 | 配置管理 + 热更新 |
| **日志** | Zap | v1.27.1 | 结构化日志 |
| **认证** | golang-jwt/jwt/v5 | v5.3.1 | JWT Token |
| **监控** | Prometheus | v1.23.2 | 指标收集 |

### 前端技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **语言** | TypeScript | ~5.9.3 | 前端主语言 |
| **框架** | Vue | ^3.5.25 | UI 框架 |
| **构建** | Vite | ^7.3.1 | 开发服务器 + 构建 |
| **UI 库** | Element Plus | ^2.13.2 | 组件库 |
| **状态** | Pinia | ^3.0.4 | 状态管理 |
| **路由** | Vue Router | ^4.6.4 | 前端路由 |
| **HTTP** | Axios | ^1.13.5 | API 请求 |

### 部署方式

| 方式 | 说明 | 推荐场景 |
|------|------|----------|
| **二进制** | 下载预编译二进制直接运行 | 个人开发、测试环境 |
| **Docker** | 官方镜像 `graperegistry/grape:latest` | 生产环境、容器化部署 |
| **Docker Compose** | `docker-compose up -d` | 快速部署、一键启动 |
| **源码构建** | `make build` | 开发环境、定制需求 |

---

## ✅ 当前已实现模块

### 核心功能

| 模块 | 功能 | 状态 |
|------|------|------|
| **用户认证** | JWT + 持久化 Token（CI/CD） | ✅ 完成 |
| **用户管理** | 创建/编辑/删除/列表 | ✅ 完成 |
| **角色权限** | admin/developer/readonly | ✅ 完成 |
| **包发布** | `npm publish` | ✅ 完成 |
| **包下载** | `npm install` + 上游代理缓存 | ✅ 完成 |
| **包删除** | `npm unpublish` | ✅ 完成 |
| **多上游路由** | 按 scope 路由到不同上游 | ✅ 完成 |
| **配置热更新** | 修改配置无需重启 | ✅ 完成 |
| **审计日志** | 操作记录 + 查询 | ✅ 完成 |
| **Webhook** | 事件通知 + 重试机制 | ✅ 完成 |
| **Prometheus** | 监控指标 + `/-/metrics` 端点 | ✅ 完成 |
| **Web UI** | 包列表/详情/管理后台 | ✅ 完成 |
| **Token 管理** | CI/CD 持久化 Token | ✅ 完成 |
| **包 Owner** | 包级别访问控制 | ✅ 完成 |
| **备份/恢复** | 数据备份工具（`grape backup/restore`） | ✅ 完成 |
| **垃圾回收** | GC 分析 + 清理 | ✅ 完成 |
| **Docker** | 镜像 + Compose 配置 | ✅ 完成 |

### 数据模型

| 模型 | 表名 | 说明 |
|------|------|------|
| `User` | `users` | 用户账户 |
| `Package` | `packages` | 包元数据（快速查询） |
| `PackageVersion` | `package_versions` | 包版本信息 |
| `Token` | `tokens` | CI/CD 持久化 Token |
| `PackageOwner` | `package_owners` | 包访问控制 |
| `AuditLog` | `audit_logs` | 审计日志 |
| `Webhook` | `webhooks` | Webhook 配置 |
| `PackageGCMetadata` | `package_gc_metadata` | GC 元数据 |
| `OrphanedFile` | `orphaned_files` | 孤立文件记录 |
| `PackageDeprecation` | `package_deprecations` | 包弃用标记 |

---

## 📊 当前开发阶段

### 版本信息

| 项目 | 值 |
|------|-----|
| **当前版本** | v0.1.0 |
| **开发阶段** | Phase 1 - 团队可用 |
| **稳定性** | 核心功能稳定，存在已知 Bug |
| **生产就绪** | ⚠️ 需修复 P0 Bug 后可用 |

### 当前状态

| 维度 | 状态 |
|------|------|
| **核心功能** | ✅ 完整实现 |
| **单元测试** | ⚠️ 覆盖率低（仅 auth/storage） |
| **集成测试** | ❌ 缺失 |
| **性能测试** | ❌ 缺失 |
| **文档完整度** | ✅ 80%+ |
| **已知 Bug** | 🔴 双端口路由冲突（P0） |

---

## 🎯 当前优先级

### P0 - 紧急阻塞（立即处理）

| 任务 | 状态 | 影响 |
|------|------|------|
| **双端口路由冲突修复** | ⚠️ 进行中 | 服务无法启动 |
| **大型包元数据限制验证** | ⚠️ 待测试 | vite/typescript 等大包可能截断 |

### P1 - 重要（本周内）

| 任务 | 状态 |
|------|------|
| **补充核心路径单元测试** | ❌ 未开始 |
| **完善部署文档** | ❌ 未开始 |
| **验证测试项目安装** | ❌ 未开始 |

### P2 - 中期（本月内）

| 任务 | 状态 |
|------|------|
| **LDAP/AD 集成** | ❌ 未开始 |
| **S3/OSS 存储支持** | ❌ 未开始 |
| **Redis 缓存层** | ❌ 未开始 |

### P3 - 长期（下季度）

| 任务 | 状态 |
|------|------|
| **高可用集群** | ❌ 未开始 |
| **插件系统** | ❌ 未开始 |
| **包安全扫描** | ❌ 未开始 |

---

## 📋 下一步建议

### 立即行动（今天）

1. **修复双端口路由 Bug**
   - 问题：Gin 路由冲突导致服务无法启动
   - 方案：回退到单端口设计或使用 NoRoute 统一处理
   - 文档：`BUG-双端口路由冲突问题.md`

2. **验证大型包下载**
   - 测试包：vite（38MB）、typescript（50MB+）
   - 验证：元数据是否完整、JSON 是否有效
   - 配置：`maxMetadataSize = 50MB`

3. **运行测试项目**
   - 项目：`test-projects/vue3-demo`
   - 命令：`npm install` + `npm run dev`
   - 验证：所有依赖正常下载、项目正常启动

### 短期行动（本周）

1. **补充单元测试**
   - 优先级：`internal/server/handler/` 下的 Handler
   - 目标：核心路径覆盖率 > 60%

2. **完善部署文档**
   - 补充故障排查指南
   - 添加性能调优建议
   - 明确 PostgreSQL 占位说明

3. **清理技术债**
   - 移除或实现 PostgreSQL 占位代码
   - 统一硬编码配置为环境变量
   - 简化复杂路由逻辑

### 中期行动（本月）

1. **性能基准测试**
   - 工具：wrk、ab
   - 指标：QPS、P99 延迟、并发能力
   - 对比：Verdaccio

2. **集成测试框架**
   - 工具：Go testing + httptest
   - 场景：publish → install → unpublish 完整流程
   - 自动化：GitHub Actions

3. **监控告警**
   - 指标：错误率、延迟、磁盘使用
   - 告警：Prometheus AlertManager
   - 可视化：Grafana Dashboard

---

## ⚠️ 风险评估

| 风险 | 等级 | 影响 | 缓解措施 |
|------|------|------|----------|
| **双端口路由 Bug** | 🔴 高 | 服务无法启动 | 优先修复或回退单端口 |
| **大型包截断** | 🟡 中 | 元数据不完整 | 已提升到 50MB，需监控 |
| **测试覆盖率低** | 🟡 中 | 回归风险 | 逐步补充核心测试 |
| **PostgreSQL 占位** | 🟡 中 | 用户困惑 | 文档明确说明仅支持 SQLite |
| **单 SQLite 文件** | 🟢 低 | 并发锁竞争 | 高并发场景建议 PostgreSQL |

---

## 📚 相关文档索引

| 文档 | 路径 | 说明 |
|------|------|------|
| **项目说明** | `README.md` | 项目介绍、快速开始 |
| **使用指南** | `docs/USAGE.md` | 包管理器配置和使用 |
| **API 文档** | `docs/API.md` | 完整 API 参考 |
| **部署指南** | `docs/DEPLOYMENT.md` | 生产环境部署 |
| **开发文档** | `docs/DEVELOPMENT.md` | 开发者指南 |
| **Webhook 文档** | `docs/WEBHOOKS.md` | Webhook 配置和使用 |
| **迭代计划** | `迭代计划.md` | 产品路线图 |
| **Bug 报告** | `BUG-双端口路由冲突问题.md` | 当前阻塞性问题 |
| **优化清单** | `开发优化清单 - 合并版.md` | 技术债和优化任务 |

---

## 🎓 推荐阅读顺序

### 新开发者

```
1. README.md                      # 项目概览
2. docs/USAGE.md                  # 使用方法
3. docs/DEVELOPMENT.md            # 开发环境搭建
4. internal/server/server.go      # 服务器入口
5. internal/registry/proxy.go     # Registry 核心
6. internal/auth/middleware.go    # 认证中间件
```

### AI 助手

```
1. .ai/ai-handoff.md              # AI 交接指南（本文档）
2. .ai/architecture.md            # 架构说明
3. .ai/coding-rules.md            # 编码规范
4. .ai/tech-debt.md               # 技术债清单
5. .ai/roadmap.md                 # 路线图
```

### 技术决策者

```
1. README.md                      # 项目定位
2. docs/DEPLOYMENT.md             # 部署方案
3. 迭代计划.md                    # 路线图
4. .ai/project-context.md         # 项目上下文（本文档）
```

---

**最后更新**: 2026-02-27  
**下次审查**: 2026-03-06（一周后）
