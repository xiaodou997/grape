# ğŸ’³ Grape Registry - æŠ€æœ¯å€ºæ¸…å•

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-02-27  
**å®¡æŸ¥å‘¨æœŸ**: æ¯åŒå‘¨è¿­ä»£å®¡æŸ¥

---

## ğŸ”´ P0 ç´§æ€¥æŠ€æœ¯å€º

### 1. åŒç«¯å£è·¯ç”±å†²çª

**ä½ç½®**: `internal/server/server.go`  
**å½±å“**: æœåŠ¡æ— æ³•å¯åŠ¨  
**æŠ€æœ¯å€ºç±»å‹**: æ¶æ„è®¾è®¡é—®é¢˜  
**ç´¯ç§¯æ—¶é—´**: 2026-02-27 è‡³ä»Š

**é—®é¢˜æè¿°**:
Gin è·¯ç”±å™¨ä¸å…è®¸åœ¨åŒä¸€ä¸ª Router å®ä¾‹ä¸­åŒæ—¶ä½¿ç”¨å…·ä½“è·¯å¾„ï¼ˆ`/-/health`ï¼‰å’Œé€šé…ç¬¦è·¯å¾„ï¼ˆ`/*filepath`ï¼‰ï¼Œå¯¼è‡´å¯åŠ¨æ—¶ panicã€‚

**ä¸´æ—¶æ–¹æ¡ˆ**: æ— ï¼ˆæœåŠ¡æ— æ³•å¯åŠ¨ï¼‰

**æ°¸ä¹…ä¿®å¤æ–¹æ¡ˆ**:
```go
// æ–¹æ¡ˆ 1: ä½¿ç”¨ NoRoute ç»Ÿä¸€å¤„ç†
s.apiRouter.NoRoute(s.handleRegistryRequest)

// handleRegistryRequest ä¸­æ‰‹åŠ¨è§£æè·¯å¾„
func (s *Server) handleRegistryRequest(c *gin.Context) {
    path := strings.TrimPrefix(c.Request.URL.Path, "/")
    if path == "-/health" {
        s.handleHealth(c)
        return
    }
    // ... å…¶ä»–è·¯å¾„å¤„ç†
}
```

**é¢„è®¡å·¥æ—¶**: 4-8 å°æ—¶  
**é£é™©**: ä¸­ï¼ˆè·¯ç”±é€»è¾‘é‡æ„ï¼‰  
**ä¼˜å…ˆçº§**: P0

---

### 2. å¤§å‹åŒ…å…ƒæ•°æ®é™åˆ¶éªŒè¯

**ä½ç½®**: `internal/registry/proxy.go`  
**å½±å“**: vite/typescript ç­‰å¤§åŒ…å¯èƒ½æˆªæ–­  
**æŠ€æœ¯å€ºç±»å‹**: é…ç½®å‚æ•°è°ƒæ•´  
**ç´¯ç§¯æ—¶é—´**: 2026-02-27 è‡³ä»Š

**é—®é¢˜æè¿°**:
`maxMetadataSize` ä» 5MB æå‡åˆ° 50MBï¼Œä½†æœªå……åˆ†éªŒè¯æ˜¯å¦è¶³å¤Ÿè¦†ç›–æ‰€æœ‰å¤§å‹åŒ…ã€‚

**å½“å‰é…ç½®**:
```go
const (
    maxMetadataSize = 50 * 1024 * 1024 // 50MB
    maxTarballSize  = 500 * 1024 * 1024
)
```

**å¾…éªŒè¯**:
- [ ] vite åŒ…å…ƒæ•°æ®å¤§å°ï¼ˆçº¦ 38MBï¼‰
- [ ] typescript åŒ…å…ƒæ•°æ®å¤§å°
- [ ] å…¶ä»–å¤§å‹åŒ…ï¼ˆ@angular/core, rxjs ç­‰ï¼‰

**é¢„è®¡å·¥æ—¶**: 2-4 å°æ—¶  
**é£é™©**: ä½  
**ä¼˜å…ˆçº§**: P0

---

## ğŸŸ  P1 é‡è¦æŠ€æœ¯å€º

### 3. å¤æ‚è·¯ç”±é€»è¾‘

**ä½ç½®**: `internal/server/server.go:handleRegistryRequest`  
**å½±å“**: å¯æµ‹è¯•æ€§å·®ï¼Œç»´æŠ¤å›°éš¾  
**æŠ€æœ¯å€ºç±»å‹**: ä»£ç å¤æ‚åº¦  
**ç´¯ç§¯æ—¶é—´**: 2026-02-27 è‡³ä»Š

**é—®é¢˜æè¿°**:
æ‰‹åŠ¨è§£æ URL è·¯å¾„ï¼Œé€»è¾‘å¤æ‚ï¼Œéš¾ä»¥å•å…ƒæµ‹è¯•ã€‚

**å½“å‰å®ç°**:
```go
func (s *Server) handleRegistryRequest(c *gin.Context) {
    filepath := c.Param("filepath")
    filepath = strings.TrimPrefix(filepath, "/")
    
    if strings.Contains(filepath, "/-/") {
        // tarball ä¸‹è½½
        idx := strings.Index(filepath, "/-/")
        packageName := filepath[:idx]
        filename := filepath[idx+3:]
        // ...
    } else {
        // åŒ…å…ƒæ•°æ®
        // ...
    }
}
```

**é‡æ„å»ºè®®**:
```go
// æå–è·¯å¾„è§£æé€»è¾‘ä¸ºç‹¬ç«‹å‡½æ•°
func parseRegistryPath(path string) (*RegistryPath, error) {
    // å•å…ƒæµ‹è¯•å‹å¥½
}

// ä½¿ç”¨ç­–ç•¥æ¨¡å¼
type RouteHandler interface {
    Match(path string) bool
    Handle(c *gin.Context)
}
```

**é¢„è®¡å·¥æ—¶**: 8-12 å°æ—¶  
**é£é™©**: ä¸­  
**ä¼˜å…ˆçº§**: P1

---

### 4. ç¡¬ç¼–ç ç«¯å£

**ä½ç½®**: `web/src/api/index.ts`  
**å½±å“**: ç¯å¢ƒé…ç½®ä¸çµæ´»  
**æŠ€æœ¯å€ºç±»å‹**: é…ç½®ç¡¬ç¼–ç   
**ç´¯ç§¯æ—¶é—´**: 2026-02-27 è‡³ä»Š

**é—®é¢˜æè¿°**:
API ç«¯å£ç¡¬ç¼–ç ä¸º 4874ï¼Œæœªä½¿ç”¨ç¯å¢ƒå˜é‡ã€‚

**å½“å‰å®ç°**:
```typescript
const API_PORT = import.meta.env.VITE_API_PORT || '4874'
```

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œä¾èµ–åå‘ä»£ç†
const API_BASE_URL = import.meta.env.VITE_API_URL || ''

// æˆ–åœ¨æ„å»ºæ—¶æ³¨å…¥
const API_BASE_URL = process.env.API_URL
```

**é¢„è®¡å·¥æ—¶**: 2-4 å°æ—¶  
**é£é™©**: ä½  
**ä¼˜å…ˆçº§**: P1

---

### 5. å•å…ƒæµ‹è¯•è¦†ç›–ç‡ä½

**ä½ç½®**: `internal/server/handler/`  
**å½±å“**: å›å½’é£é™©é«˜  
**æŠ€æœ¯å€ºç±»å‹**: æµ‹è¯•ç¼ºå¤±  
**ç´¯ç§¯æ—¶é—´**: é¡¹ç›®å¼€å§‹è‡³ä»Š

**å½“å‰çŠ¶æ€**:
| æ¨¡å— | è¦†ç›–ç‡ | ç›®æ ‡ |
|------|--------|------|
| `internal/auth/` | ~80% | âœ… è¾¾æ ‡ |
| `internal/storage/` | ~70% | âœ… è¾¾æ ‡ |
| `internal/server/handler/` | < 20% | âŒ éœ€æ”¹è¿› |
| `internal/registry/` | < 10% | âŒ éœ€æ”¹è¿› |

**å¾…è¡¥å……æµ‹è¯•**:
- [ ] `handler/auth.go` - è®¤è¯é€»è¾‘
- [ ] `handler/publish.go` - å‘å¸ƒé€»è¾‘
- [ ] `handler/registry.go` - Registry é€»è¾‘
- [ ] `handler/token.go` - Token ç®¡ç†
- [ ] `registry/proxy.go` - ä¸Šæ¸¸ä»£ç†

**é¢„è®¡å·¥æ—¶**: 24-32 å°æ—¶  
**é£é™©**: ä¸­  
**ä¼˜å…ˆçº§**: P1

---

## ğŸŸ¡ P2 ä¸­æœŸæŠ€æœ¯å€º

### 6. PostgreSQL å ä½ä»£ç 

**ä½ç½®**: `internal/db/db.go`  
**å½±å“**: ç”¨æˆ·å›°æƒ‘  
**æŠ€æœ¯å€ºç±»å‹**: æœªå®ç°åŠŸèƒ½  
**ç´¯ç§¯æ—¶é—´**: é¡¹ç›®å¼€å§‹è‡³ä»Š

**é—®é¢˜æè¿°**:
ä»£ç æ”¯æŒ PostgreSQL é…ç½®ï¼Œä½†å®é™…è¿”å›"not implemented yet"ã€‚

**å½“å‰å®ç°**:
```go
switch cfg.Type {
case "sqlite":
    // ... å®ç°
case "postgres":
    return fmt.Errorf("postgres not implemented yet")
default:
    return fmt.Errorf("unsupported database type: %s", cfg.Type)
}
```

**å»ºè®®æ–¹æ¡ˆ**:
1. **ç§»é™¤å ä½**: æ˜ç¡®è¯´æ˜ä»…æ”¯æŒ SQLite
2. **å®ç°åŠŸèƒ½**: å®Œæ•´æ”¯æŒ PostgreSQL

**é¢„è®¡å·¥æ—¶**: 
- ç§»é™¤ï¼š2 å°æ—¶
- å®ç°ï¼š24-32 å°æ—¶

**é£é™©**: ä½ï¼ˆç§»é™¤ï¼‰/ ä¸­ï¼ˆå®ç°ï¼‰  
**ä¼˜å…ˆçº§**: P2ï¼ˆç§»é™¤ä¼˜å…ˆï¼‰

---

### 7. Webhook åŒæ­¥æ¨é€

**ä½ç½®**: `internal/webhook/webhook.go`  
**å½±å“**: å¯èƒ½é˜»å¡è¯·æ±‚  
**æŠ€æœ¯å€ºç±»å‹**: æ€§èƒ½é—®é¢˜  
**ç´¯ç§¯æ—¶é—´**: é¡¹ç›®å¼€å§‹è‡³ä»Š

**é—®é¢˜æè¿°**:
Webhook äº‹ä»¶åŒæ­¥æ¨é€ï¼Œå¯èƒ½é˜»å¡ä¸»è¯·æ±‚æµç¨‹ã€‚

**å½“å‰å®ç°**:
```go
func (d *Dispatcher) Dispatch(event Event) error {
    for _, hook := range d.webhooks {
        // åŒæ­¥ HTTP è¯·æ±‚
        resp, err := http.Post(hook.URL, ...)
        // é‡è¯•é€»è¾‘ï¼ˆåŒæ­¥ï¼‰
    }
}
```

**æ”¹è¿›æ–¹æ¡ˆ**:
```go
// å¼‚æ­¥é˜Ÿåˆ—
func (d *Dispatcher) Dispatch(event Event) error {
    go func() {
        d.eventQueue <- event
    }()
    return nil
}

// åå° worker å¤„ç†
func (d *Dispatcher) worker() {
    for event := range d.eventQueue {
        d.processEvent(event)
    }
}
```

**é¢„è®¡å·¥æ—¶**: 12-16 å°æ—¶  
**é£é™©**: ä¸­  
**ä¼˜å…ˆçº§**: P2

---

### 8. æ— é€Ÿç‡é™åˆ¶

**ä½ç½®**: `internal/server/server.go`  
**å½±å“**: API æ»¥ç”¨é£é™©  
**æŠ€æœ¯å€ºç±»å‹**: å®‰å…¨ç¼ºå¤±  
**ç´¯ç§¯æ—¶é—´**: é¡¹ç›®å¼€å§‹è‡³ä»Š

**é—®é¢˜æè¿°**:
ä»…ç™»å½•æ¥å£æœ‰é™æµï¼Œå…¶ä»– API æ— é€Ÿç‡é™åˆ¶ã€‚

**å½“å‰å®ç°**:
```go
// ä»…ç™»å½•é™æµ
handler.InitLoginLimiter()
```

**æ”¹è¿›æ–¹æ¡ˆ**:
```go
// å…¨å±€é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
func RateLimitMiddleware() gin.HandlerFunc {
    limiter := rate.NewLimiter(rate.Every(time.Minute), 100)
    return func(c *gin.Context) {
        if !limiter.Allow() {
            c.JSON(http.StatusTooManyRequests, gin.H{
                "error": "rate limit exceeded",
            })
            c.Abort()
            return
        }
        c.Next()
    }
}
```

**é¢„è®¡å·¥æ—¶**: 8-12 å°æ—¶  
**é£é™©**: ä½  
**ä¼˜å…ˆçº§**: P2

---

## ğŸŸ¢ P3 é•¿æœŸæŠ€æœ¯å€º

### 9. å• SQLite æ–‡ä»¶å¹¶å‘é™åˆ¶

**ä½ç½®**: `internal/db/`  
**å½±å“**: é«˜å¹¶å‘åœºæ™¯æ€§èƒ½ç“¶é¢ˆ  
**æŠ€æœ¯å€ºç±»å‹**: æ¶æ„é™åˆ¶  
**ç´¯ç§¯æ—¶é—´**: é¡¹ç›®å¼€å§‹è‡³ä»Š

**é—®é¢˜æè¿°**:
SQLite å•æ–‡ä»¶å†™å…¥é”é™åˆ¶ï¼Œé«˜å¹¶å‘åœºæ™¯æ€§èƒ½ä¸‹é™ã€‚

**å½±å“åœºæ™¯**:
- å¤šç”¨æˆ·åŒæ—¶å‘å¸ƒåŒ…
- é«˜é¢‘å…ƒæ•°æ®æ›´æ–°
- æ‰¹é‡å¯¼å…¥æ“ä½œ

**æ”¹è¿›æ–¹æ¡ˆ**:
1. **çŸ­æœŸ**: WAL æ¨¡å¼ä¼˜åŒ–
2. **ä¸­æœŸ**: PostgreSQL æ”¯æŒ
3. **é•¿æœŸ**: è¯»å†™åˆ†ç¦»

**é¢„è®¡å·¥æ—¶**: 24-48 å°æ—¶  
**é£é™©**: é«˜  
**ä¼˜å…ˆçº§**: P3

---

### 10. æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨

**ä½ç½®**: `internal/storage/local/`  
**å½±å“**: æ— æ³•æ°´å¹³æ‰©å±•  
**æŠ€æœ¯å€ºç±»å‹**: æ¶æ„é™åˆ¶  
**ç´¯ç§¯æ—¶é—´**: é¡¹ç›®å¼€å§‹è‡³ä»Š

**é—®é¢˜æè¿°**:
åŒ…æ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œæ— æ³•å¤šå®ä¾‹å…±äº«ã€‚

**æ”¹è¿›æ–¹æ¡ˆ**:
```go
// å­˜å‚¨æ¥å£å·²æœ‰æŠ½è±¡
type Storage interface {
    SavePackage(name string, data []byte) error
    GetPackage(name string) ([]byte, error)
}

// å®ç° S3 å­˜å‚¨
type S3Storage struct {
    client *s3.Client
    bucket string
}

func (s *S3Storage) SavePackage(name string, data []byte) error {
    _, err := s.client.PutObject(...)
    return err
}
```

**é¢„è®¡å·¥æ—¶**: 16-24 å°æ—¶  
**é£é™©**: ä¸­  
**ä¼˜å…ˆçº§**: P3

---

### 11. é›†æˆæµ‹è¯•ç¼ºå¤±

**ä½ç½®**: å…¨é¡¹ç›®  
**å½±å“**: å›å½’é£é™©é«˜  
**æŠ€æœ¯å€ºç±»å‹**: æµ‹è¯•ç¼ºå¤±  
**ç´¯ç§¯æ—¶é—´**: é¡¹ç›®å¼€å§‹è‡³ä»Š

**å¾…å®ç°åœºæ™¯**:
- [ ] publish â†’ install â†’ unpublish å®Œæ•´æµç¨‹
- [ ] Token è®¤è¯ + å‘å¸ƒ
- [ ] å¤šä¸Šæ¸¸è·¯ç”±
- [ ] Webhook äº‹ä»¶è§¦å‘
- [ ] å¤‡ä»½ â†’ æ¢å¤å®Œæ•´æµç¨‹

**å»ºè®®æ¡†æ¶**:
```go
// ä½¿ç”¨ httptest æ¨¡æ‹Ÿ HTTP æœåŠ¡å™¨
func TestPublishInstallFlow(t *testing.T) {
    server := httptest.NewServer(createApp())
    defer server.Close()
    
    // æ¨¡æ‹Ÿ npm publish
    // æ¨¡æ‹Ÿ npm install
    // éªŒè¯ç»“æœ
}
```

**é¢„è®¡å·¥æ—¶**: 24-32 å°æ—¶  
**é£é™©**: ä¸­  
**ä¼˜å…ˆçº§**: P3

---

## ğŸ“Š æŠ€æœ¯å€ºç»Ÿè®¡

### æŒ‰ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ•°é‡ | é¢„è®¡å·¥æ—¶ |
|--------|------|----------|
| **P0** | 2 | 6-12 å°æ—¶ |
| **P1** | 4 | 36-52 å°æ—¶ |
| **P2** | 3 | 22-30 å°æ—¶ |
| **P3** | 3 | 64-104 å°æ—¶ |
| **æ€»è®¡** | 12 | 128-198 å°æ—¶ |

### æŒ‰ç±»å‹

| ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| **æ¶æ„è®¾è®¡** | 3 | è·¯ç”±ã€å­˜å‚¨ã€æ•°æ®åº“ |
| **æµ‹è¯•ç¼ºå¤±** | 2 | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯• |
| **æ€§èƒ½é—®é¢˜** | 2 | Webhook åŒæ­¥ã€SQLite å¹¶å‘ |
| **å®‰å…¨ç¼ºå¤±** | 1 | é€Ÿç‡é™åˆ¶ |
| **é…ç½®ç¡¬ç¼–ç ** | 1 | ç«¯å£ç¡¬ç¼–ç  |
| **æœªå®ç°åŠŸèƒ½** | 2 | PostgreSQLã€S3 |
| **ä»£ç å¤æ‚åº¦** | 1 | è·¯ç”±é€»è¾‘ |

---

## ğŸ“‹ å¿è¿˜è®¡åˆ’

### Sprint 1-2 (æœ¬å‘¨)

**ç›®æ ‡**: è§£å†³ P0 ç´§æ€¥æŠ€æœ¯å€º

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|----------|
| ä¿®å¤åŒç«¯å£è·¯ç”± | P0 | 4-8 å°æ—¶ |
| éªŒè¯å¤§å‹åŒ…é™åˆ¶ | P0 | 2-4 å°æ—¶ |

### Sprint 3-4 (ä¸‹å‘¨)

**ç›®æ ‡**: è§£å†³ P1 é‡è¦æŠ€æœ¯å€º

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|----------|
| ç®€åŒ–è·¯ç”±é€»è¾‘ | P1 | 8-12 å°æ—¶ |
| ä¿®å¤ç¡¬ç¼–ç ç«¯å£ | P1 | 2-4 å°æ—¶ |
| è¡¥å…… Handler æµ‹è¯• | P1 | 12-16 å°æ—¶ |

### Sprint 5-8 (æœ¬æœˆ)

**ç›®æ ‡**: è§£å†³ P2 ä¸­æœŸæŠ€æœ¯å€º

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|----------|
| ç§»é™¤ PostgreSQL å ä½ | P2 | 2 å°æ—¶ |
| Webhook å¼‚æ­¥åŒ– | P2 | 12-16 å°æ—¶ |
| å®ç°é€Ÿç‡é™åˆ¶ | P2 | 8-12 å°æ—¶ |

### Quarter 2 (ä¸‹å­£åº¦)

**ç›®æ ‡**: è§£å†³ P3 é•¿æœŸæŠ€æœ¯å€º

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|----------|
| PostgreSQL æ”¯æŒ | P3 | 24-32 å°æ—¶ |
| S3 å­˜å‚¨æ”¯æŒ | P3 | 16-24 å°æ—¶ |
| é›†æˆæµ‹è¯•æ¡†æ¶ | P3 | 24-32 å°æ—¶ |

---

## ğŸ¯ æŠ€æœ¯å€ºç®¡ç†åŸåˆ™

### è¯†åˆ«åŸåˆ™

1. **æ–°ä»£ç å¿…é¡»å®¡æŸ¥**: æ¯æ¬¡ PR å¿…é¡»å®¡æŸ¥æ˜¯å¦å¼•å…¥æ–°æŠ€æœ¯å€º
2. **æŠ€æœ¯å€ºå¿…é¡»è®°å½•**: æ‰€æœ‰æŠ€æœ¯å€ºå¿…é¡»è®°å½•åœ¨æ­¤æ–‡æ¡£
3. **æŠ€æœ¯å€ºå¿…é¡»è¯„ä¼°**: è¯„ä¼°å½±å“ã€å·¥æ—¶ã€ä¼˜å…ˆçº§

### å¿è¿˜åŸåˆ™

1. **P0 ç«‹å³å¿è¿˜**: é˜»å¡æ€§é—®é¢˜ç«‹å³ä¿®å¤
2. **P1 æœ¬å‘¨å¿è¿˜**: é‡è¦é—®é¢˜æœ¬å‘¨å†…ä¿®å¤
3. **P2 æœ¬æœˆå¿è¿˜**: ä¸­æœŸé—®é¢˜æœ¬æœˆå†…ä¿®å¤
4. **P3 è§„åˆ’å¿è¿˜**: é•¿æœŸé—®é¢˜çº³å…¥å­£åº¦è§„åˆ’

### é¢„é˜²åŸåˆ™

1. **ä»£ç å®¡æŸ¥**: æ‰€æœ‰ä»£ç å¿…é¡»ç»è¿‡å®¡æŸ¥
2. **æµ‹è¯•è¦†ç›–**: æ–°åŠŸèƒ½å¿…é¡»æœ‰æµ‹è¯•
3. **æ–‡æ¡£åŒæ­¥**: ä»£ç å˜æ›´å¿…é¡»åŒæ­¥æ–‡æ¡£
4. **å®šæœŸå®¡æŸ¥**: æ¯åŒå‘¨å®¡æŸ¥æŠ€æœ¯å€ºæ¸…å•

---

**æœ€åæ›´æ–°**: 2026-02-27  
**ä¸‹æ¬¡å®¡æŸ¥**: 2026-03-13  
**è´Ÿè´£äºº**: Grape Team
