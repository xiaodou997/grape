name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  # ç”Ÿæˆ Changelog
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
      contributors: ${{ steps.contributors.outputs.contributors }}
      commit_count: ${{ steps.stats.outputs.commit_count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag å’Œå½“å‰ tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          
          echo "Previous tag: $PREV_TAG"
          echo "Current tag: $CURRENT_TAG"
          
          # è·å–æäº¤å†å²
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, getting last 50 commits"
            COMMITS=$(git log --pretty=format:"%s" -n 50)
          else
            echo "Getting commits from $PREV_TAG to $CURRENT_TAG"
            COMMITS=$(git log --pretty=format:"%s" "$PREV_TAG..HEAD")
          fi
          
          # åˆå§‹åŒ–å„ä¸ªç±»åˆ«
          FEATS=""
          FIXES=""
          DOCS=""
          STYLES=""
          REFACTORS=""
          PERFS=""
          TESTS=""
          BUILDS=""
          CI=""
          CHORES=""
          REVERTS=""
          
          # å¤„ç†æ¯ä¸ªæäº¤
          while IFS= read -r COMMIT; do
            # è·³è¿‡ç©ºè¡Œ
            [ -z "$COMMIT" ] && continue
            
            # æ ¹æ® commit message åˆ†ç±»
            case "$COMMIT" in
              feat:*) FEATS="$FEATS\n* $COMMIT" ;;
              fix:*) FIXES="$FIXES\n* $COMMIT" ;;
              docs:*) DOCS="$DOCS\n* $COMMIT" ;;
              style:*) STYLES="$STYLES\n* $COMMIT" ;;
              refactor:*) REFACTORS="$REFACTORS\n* $COMMIT" ;;
              perf:*) PERFS="$PERFS\n* $COMMIT" ;;
              test:*) TESTS="$TESTS\n* $COMMIT" ;;
              build:*) BUILDS="$BUILDS\n* $COMMIT" ;;
              ci:*) CI="$CI\n* $COMMIT" ;;
              chore:*) CHORES="$CHORES\n* $COMMIT" ;;
              revert:*) REVERTS="$REVERTS\n* $COMMIT" ;;
              *) 
                # å…¶ä»–æäº¤ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”®è¯
                if echo "$COMMIT" | grep -qi "add\|new\|create"; then
                  FEATS="$FEATS\n* $COMMIT"
                elif echo "$COMMIT" | grep -qi "fix\|bug\|issue"; then
                  FIXES="$FIXES\n* $COMMIT"
                else
                  CHORES="$CHORES\n* $COMMIT"
                fi
                ;;
            esac
          done <<< "$COMMITS"
          
          # æ„å»ºç»“æ„åŒ–çš„ changelog
          CHANGELOG=""
          
          [ ! -z "$FEATS" ] && CHANGELOG="$CHANGELOG\n\n### ğŸš€ æ–°åŠŸèƒ½\n$FEATS"
          [ ! -z "$FIXES" ] && CHANGELOG="$CHANGELOG\n\n### ğŸ› Bug ä¿®å¤\n$FIXES"
          [ ! -z "$PERFS" ] && CHANGELOG="$CHANGELOG\n\n### âš¡ æ€§èƒ½ä¼˜åŒ–\n$PERFS"
          [ ! -z "$REFACTORS" ] && CHANGELOG="$CHANGELOG\n\n### ğŸ”¨ é‡æ„\n$REFACTORS"
          [ ! -z "$DOCS" ] && CHANGELOG="$CHANGELOG\n\n### ğŸ“š æ–‡æ¡£æ›´æ–°\n$DOCS"
          [ ! -z "$TESTS" ] && CHANGELOG="$CHANGELOG\n\n### ğŸ§ª æµ‹è¯•\n$TESTS"
          [ ! -z "$BUILDS" ] && CHANGELOG="$CHANGELOG\n\n### ğŸ—ï¸ æ„å»º\n$BUILDS"
          [ ! -z "$CI" ] && CHANGELOG="$CHANGELOG\n\n### ğŸ”„ CI/CD\n$CI"
          [ ! -z "$REVERTS" ] && CHANGELOG="$CHANGELOG\n\n### â†©ï¸ å›æ»š\n$REVERTS"
          [ ! -z "$CHORES" ] && CHANGELOG="$CHANGELOG\n\n### ğŸ“ å…¶ä»–\n$CHORES"
          
          # å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="\n\n### ğŸ“ æœ¬æ¬¡ç‰ˆæœ¬åŒ…å«äº†ä¸€äº›å°çš„ä¼˜åŒ–å’Œä¿®å¤ã€‚"
          fi
          
          # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯å’Œç»Ÿè®¡
          HEADER="## ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯\n\n**ç‰ˆæœ¬å·**: \`$CURRENT_TAG\`\n**å‘å¸ƒæ—¥æœŸ**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n"
          
          # ç»Ÿè®¡æäº¤æ•°é‡
          COMMIT_COUNT=$(echo -e "$COMMITS" | wc -l | tr -d ' ')
          STATS="\n\n---\n\n## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n\n**æäº¤æ•°é‡**: $COMMIT_COUNT\n"
          
          # åˆå¹¶æ‰€æœ‰å†…å®¹
          FULL_CHANGELOG="$HEADER$STATS$CHANGELOG"
          
          # å®‰å…¨åœ°è®¾ç½®å¤šè¡Œè¾“å‡º
          DELIMITER=$(openssl rand -hex 16)
          {
            echo "changelog<<$DELIMITER"
            echo -e "$FULL_CHANGELOG"
            echo "$DELIMITER"
          } >> $GITHUB_OUTPUT
          
          echo "Generated structured changelog"

      - name: Get Contributors
        id: contributors
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          
          if [ -z "$PREV_TAG" ]; then
            CONTRIBUTORS=$(git log --pretty=format:"%an" -n 50 | sort -u | grep -v "dependabot\|github-actions" | head -n 10)
          else
            CONTRIBUTORS=$(git log --pretty=format:"%an" "$PREV_TAG..HEAD" | sort -u | grep -v "dependabot\|github-actions" | head -n 10)
          fi
          
          # æ ¼å¼åŒ–ä¸ºåˆ—è¡¨
          CONTRIBUTOR_LIST=""
          while IFS= read -r contributor; do
            [ -z "$contributor" ] && continue
            CONTRIBUTOR_LIST="$CONTRIBUTOR_LIST\n* @$contributor"
          done <<< "$CONTRIBUTORS"
          
          if [ -z "$CONTRIBUTOR_LIST" ]; then
            CONTRIBUTOR_LIST="* æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…ï¼"
          fi
          
          DELIMITER=$(openssl rand -hex 16)
          {
            echo "contributors<<$DELIMITER"
            echo -e "$CONTRIBUTOR_LIST"
            echo "$DELIMITER"
          } >> $GITHUB_OUTPUT

      - name: Get Stats
        id: stats
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          
          if [ -z "$PREV_TAG" ]; then
            COMMIT_COUNT=$(git log --pretty=format:"%s" -n 50 | wc -l | tr -d ' ')
          else
            COMMIT_COUNT=$(git log --pretty=format:"%s" "$PREV_TAG..HEAD" | wc -l | tr -d ' ')
          fi
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

  # æ„å»ºå’Œå‘å¸ƒ
  build:
    name: Build & Release Binaries
    needs: changelog
    permissions:
      contents: write
      discussions: write

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds - ä½¿ç”¨ ubuntu runner
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          # macOS builds - ä½¿ç”¨ macos runner
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          # Windows builds - ä½¿ç”¨ windows runner
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: .exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Build frontend
        shell: bash
        working-directory: web
        run: |
          echo "Installing dependencies..."
          npm ci
          echo "Building frontend..."
          npm run build
          echo "Verifying dist directory..."
          ls -la dist/
          echo "Copying to internal/web/dist..."
          rm -rf ../internal/web/dist
          cp -r dist ../internal/web/dist/
          echo "Build completed successfully"

      - name: Verify frontend build
        shell: bash
        run: |
          echo "Checking internal/web/dist contents..."
          ls -la internal/web/dist/
          if [ ! -f "internal/web/dist/index.html" ]; then
            echo "::error::Frontend build failed: index.html not found"
            exit 1
          fi
          echo "Frontend build verified successfully"

      - name: Install cross-compiler for Linux ARM64
        if: matrix.goos == 'linux' && matrix.goarch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binary
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: ${{ (matrix.goos != 'windows') && '1' || '0' }}
          CC: ${{ matrix.goos == 'linux' && matrix.goarch == 'arm64' && 'aarch64-linux-gnu-gcc' || '' }}
        run: |
          OUTPUT="grape-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}"
          go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" \
            -o "$OUTPUT" ./cmd/grape
          echo "OUTPUT=$OUTPUT" >> $GITHUB_ENV
          echo "Built: $OUTPUT ($(du -h "$OUTPUT" | cut -f1))"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ${{ needs.changelog.outputs.changelog }}
            
            ---
            
            ## ğŸ‘¥ è´¡çŒ®è€…
            
            ${{ needs.changelog.outputs.contributors }}
            
            ---
            
            ## ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            | å¹³å° | æ¶æ„ | æ–‡ä»¶å |
            |------|------|--------|
            | Linux | x86_64 | grape-linux-amd64 |
            | Linux | ARM64 | grape-linux-arm64 |
            | macOS | Intel | grape-darwin-amd64 |
            | macOS | Apple Silicon | grape-darwin-arm64 |
            | Windows | x86_64 | grape-windows-amd64.exe |
            
            ### å¿«é€Ÿå¼€å§‹
            
            \`\`\`bash
            # ä¸‹è½½
            curl -sL https://github.com/graperegistry/grape/releases/latest/download/grape-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }} -o grape${{ matrix.ext }}
            chmod +x grape${{ matrix.ext }}
            
            # è¿è¡Œ
            ./grape${{ matrix.ext }}
            \`\`\`
            
            ### éªŒè¯
            
            \`\`\`bash
            # æŸ¥çœ‹ç‰ˆæœ¬
            ./grape${{ matrix.ext }} --version
            \`\`\`
          generate_release_notes: false
          files: ${{ env.OUTPUT }}
          make_latest: true
          discussion_category_name: Announcements
          prerelease: false
